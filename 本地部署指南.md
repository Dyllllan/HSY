# 本地部署指南

## 文档概述

本文档将详细说明如何从GitHub拉取代码并在本地部署这个基于Django和Wagtail的求职平台网站，包括数据库的正确迁移和配置。

## 项目信息

- **框架**: Django 5.2 + Wagtail 7.2
- **数据库**: MySQL
- **缓存**: Redis (可选)
- **Python版本**: 3.12+
- **项目结构**: 主项目目录为 `mysite/`

## 前置要求

### 1. 系统要求

- Python 3.12 或更高版本
- MySQL 5.7+ 或 MySQL 8.0+
- Redis (可选，用于缓存和会话)
- Git
- pip (Python包管理器)

### 2. 安装MySQL

#### Windows:

1. 下载MySQL安装程序: https://dev.mysql.com/downloads/installer/
2. 运行安装程序，选择"Developer Default"或"Server only"
3. 设置root用户密码（记住这个密码，后续配置需要）
4. 确保MySQL服务正在运行

#### Linux (Ubuntu/Debian):

```bash
sudo apt update
sudo apt install mysql-server
sudo mysql_secure_installation
```

#### macOS:

```bash
brew install mysql
brew services start mysql
```

### 3. 安装Redis (可选但推荐)

#### Windows:

下载并安装: https://github.com/microsoftarchive/redis/releases

#### Linux:

```bash
sudo apt install redis-server
sudo systemctl start redis
```

#### macOS:

```bash
brew install redis
brew services start redis
```

## 部署步骤

### 步骤1: 从GitHub克隆代码

```bash
# 克隆仓库
git clone <你的GitHub仓库URL>
cd pj2
```

### 步骤2: 创建Python虚拟环境

```bash
# Windows
python -m venv env
env\Scripts\activate

# Linux/macOS
python3 -m venv env
source env/bin/activate
```

### 步骤3: 安装Python依赖

```bash
# 进入项目目录
cd mysite

# 安装依赖
pip install -r requirements.txt

# 如果安装brotli库遇到问题，参考 mysite/job_crawlers/安装brotli库说明.md
```

**注意**: 如果使用MySQL，可能需要安装MySQL客户端库：

```bash
# Windows
# 通常PyMySQL已经足够，如果遇到问题，可能需要安装mysqlclient
pip install mysqlclient

# Linux
sudo apt install python3-dev default-libmysqlclient-dev build-essential
pip install mysqlclient

# macOS
brew install mysql-client
export PATH="/usr/local/opt/mysql-client/bin:$PATH"
pip install mysqlclient
```

### 步骤4: 配置数据库

#### 4.1 创建MySQL数据库

```bash
# 登录MySQL
mysql -u root -p

# 在MySQL命令行中执行
CREATE DATABASE project CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'your_username'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON project.* TO 'your_username'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

#### 4.2 配置数据库连接

编辑 `mysite/local/settings/base.py` 文件，修改数据库配置：

```python
DATABASES = {
    "default": {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'project',  # 数据库名称
        'USER': 'your_username',  # 你的MySQL用户名
        'PASSWORD': 'your_password',  # 你的MySQL密码
        'HOST': 'localhost',
        'PORT': '3306',
        'OPTIONS': {
            'charset': 'utf8mb4',
            'init_command': "SET sql_mode='STRICT_TRANS_TABLES'",
        }
    }
}
```

**重要**: 项目已经配置了PyMySQL，在 `mysite/local/__init__.py` 中已经包含了以下配置：

```python
import pymysql
pymysql.install_as_MySQLdb()
```

如果遇到MySQL连接问题，请检查此文件是否存在并包含上述代码。

### 步骤5: 配置环境变量（可选）

对于生产环境，建议使用环境变量。创建 `.env` 文件（不要提交到Git）：

```bash
# 在 mysite/ 目录下创建 .env 文件
SECRET_KEY=your-secret-key-here
DB_NAME=project
DB_USER=your_username
DB_PASSWORD=your_password
DB_HOST=localhost
DB_PORT=3306
REDIS_URL=redis://127.0.0.1:6379/1
```

然后修改 `mysite/local/settings/dev.py` 使用环境变量（如果需要）。

### 步骤6: 运行数据库迁移

这是确保数据库正确迁移的关键步骤：

```bash
# 确保在 mysite/ 目录下
cd mysite

# 创建迁移文件（如果需要）
python manage.py makemigrations

# 执行迁移
python manage.py migrate

# 如果遇到迁移错误，参考项目根目录下的 解决数据库迁移错误.md
```

**迁移顺序**:

1. 首先迁移Django核心应用
2. 然后迁移Wagtail相关应用
3. 最后迁移自定义应用（home, jobs等）

**重要提示**: 

- 如果这是第一次部署，迁移会自动按顺序执行
- 如果遇到 `Table 'project.xxx' doesn't exist` 错误，请参考 `解决数据库迁移错误.md`
- 可以使用 `python manage.py showmigrations` 查看迁移状态

### 步骤7: 创建超级用户

```bash
python manage.py createsuperuser
```

按提示输入：

- 邮箱（Email）
- 密码（Password）
- 确认密码（Password confirmation）

**注意**: 由于项目配置了 `ACCOUNT_USERNAME_REQUIRED = False`，用户名不是必需的。

### 步骤8: 收集静态文件

```bash
python manage.py collectstatic --noinput
```

这将收集所有静态文件到 `static/` 目录。

### 步骤9: 配置Redis缓存（可选）

如果安装了Redis，编辑 `mysite/local/settings/dev.py` 添加缓存配置：

```python
CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': 'redis://127.0.0.1:6379/1',
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        }
    }
}
```

**注意**: 如果不配置Redis，Django会使用数据库缓存作为后备方案。

### 步骤10: 启动开发服务器

```bash
python manage.py runserver
```

服务器将在 `http://127.0.0.1:8000` 启动。

**重要**: 确保使用 `http://` 而不是 `https://`。如果遇到HTTPS错误，参考项目根目录下的 `解决HTTPS错误指南.md`。

### 步骤11: 访问网站

- **前端**: http://localhost:8000
- **Wagtail管理后台**: http://localhost:8000/admin/
- **Django管理后台**: http://localhost:8000/django-admin/

使用步骤7创建的超级用户账号登录。

## 验证部署

### 1. 检查数据库表

```bash
mysql -u root -p project

# 在MySQL中执行
SHOW TABLES;
```

应该看到以下主要表：

- `django_migrations`
- `wagtailcore_*`
- `jobs_*`
- `home_*`
- 等等

### 2. 检查静态文件

访问 http://localhost:8000/admin/，检查CSS和JavaScript是否正常加载。

### 3. 测试数据库连接

```bash
python manage.py dbshell
```

如果成功进入MySQL命令行，说明数据库连接正常。

### 4. 检查迁移状态

```bash
python manage.py showmigrations
```

所有应用的迁移应该都显示 `[X]`（已应用）。

## 常见问题排查

### 问题1: 数据库连接错误

**错误**: `django.db.utils.OperationalError: (2003, "Can't connect to MySQL server")`

**解决方案**:

1. 检查MySQL服务是否运行
   - Windows: 在服务管理器中检查MySQL服务状态
   - Linux: `sudo systemctl status mysql`
   - macOS: `brew services list`
2. 检查数据库配置是否正确（`mysite/local/settings/base.py`）
3. 检查防火墙设置
4. 确认数据库用户权限
5. 检查 `mysite/local/__init__.py` 是否包含PyMySQL配置

### 问题2: 迁移错误

**错误**: `Table 'project.xxx' doesn't exist`

**解决方案**:

1. 参考 `解决数据库迁移错误.md`
2. 检查迁移文件是否存在（`mysite/jobs/migrations/` 等目录）
3. 运行 `python manage.py showmigrations` 查看迁移状态
4. 按顺序执行迁移：
   ```bash
   python manage.py migrate
   ```
5. 如果特定迁移有问题，可以尝试：
   ```bash
   python manage.py migrate jobs 0003_recommendationspage
   ```

### 问题3: 静态文件404错误

**解决方案**:

1. 运行 `python manage.py collectstatic`
2. 检查 `STATIC_ROOT` 和 `STATIC_URL` 配置
3. 确保 `DEBUG = True` 在开发环境中
4. 检查 `mysite/static/` 目录是否存在且有文件

### 问题4: 模块导入错误

**错误**: `ModuleNotFoundError: No module named 'xxx'`

**解决方案**:

1. 确保虚拟环境已激活
2. 运行 `pip install -r requirements.txt`
3. 检查Python路径
4. 确认在正确的目录下运行命令（`mysite/` 目录）

### 问题5: PyMySQL连接问题

**错误**: `ModuleNotFoundError: No module named 'pymysql'`

**解决方案**:

1. 安装PyMySQL: `pip install PyMySQL`
2. 检查 `mysite/local/__init__.py` 是否包含：
   ```python
   import pymysql
   pymysql.install_as_MySQLdb()
   ```

### 问题6: 端口被占用

**错误**: `Error: That port is already in use`

**解决方案**:

```bash
# 使用其他端口
python manage.py runserver 8001
```

### 问题7: 权限错误

**错误**: 文件或目录权限相关错误

**解决方案**:

1. 确保对项目目录有读写权限
2. 确保 `mysite/media/` 和 `mysite/static/` 目录存在且有写权限
3. Linux/macOS: `chmod -R 755 mysite/`

## 数据库迁移详细说明

### 迁移前的准备

1. **备份现有数据**（如果有）:
   ```bash
   mysqldump -u root -p project > backup.sql
   ```

2. **检查迁移文件**:
   ```bash
   python manage.py showmigrations
   ```

### 执行迁移

```bash
# 1. 创建新的迁移文件（如果有模型变更）
python manage.py makemigrations

# 2. 查看将要执行的迁移
python manage.py showmigrations --plan

# 3. 执行所有迁移
python manage.py migrate

# 4. 验证迁移结果
python manage.py showmigrations
```

### 迁移特定应用

```bash
# 只迁移jobs应用
python manage.py migrate jobs

# 迁移到特定版本
python manage.py migrate jobs 0003_recommendationspage
```

### 回滚迁移（谨慎使用）

```bash
# 回滚到上一个版本
python manage.py migrate jobs 0002_jobapplication

# 回滚所有迁移（会删除表，谨慎！）
python manage.py migrate jobs zero
```

## 生产环境部署（参考）

对于生产环境，建议：

1. 使用 `local.settings.production` 配置
2. 设置环境变量（SECRET_KEY, DB_PASSWORD等）
3. 使用Gunicorn或uWSGI作为WSGI服务器
4. 使用Nginx作为反向代理
5. 配置SSL证书
6. 设置 `DEBUG = False`
7. 配置日志系统

参考 `mysite/local/settings/production.py` 获取生产环境配置示例。

### 使用Gunicorn启动（生产环境）

```bash
# 安装Gunicorn
pip install gunicorn

# 启动服务
gunicorn local.wsgi:application --bind 0.0.0.0:8000
```

## 额外功能

### 运行爬虫

如果需要运行职位爬虫，参考 `mysite/job_crawlers/运行爬虫指南.md`。

基本步骤：

```bash
cd mysite/job_crawlers
scrapy crawl zhilian
```

### Wagtail页面设置

1. 登录Wagtail管理后台 (http://localhost:8000/admin/)
2. 创建站点根页面
3. 配置站点设置（Settings > Sites）
4. 创建必要的页面结构

### 创建Wagtail站点

如果首次部署，需要创建Wagtail站点：

1. 登录Wagtail管理后台
2. 进入 Settings > Sites
3. 添加新站点，设置：
   - Site name: 你的站点名称
   - Hostname: localhost
   - Port: 8000
   - Root page: 选择根页面

## 技术支持

如果遇到问题：

1. 检查项目根目录下的文档：
   - `解决数据库迁移错误.md`
   - `解决HTTPS错误指南.md`
   - `Wagtail推荐页面集成指南.md`
2. 查看Django日志：`mysite/logs/django.log`
3. 运行 `python manage.py check` 检查配置
4. 运行 `python manage.py check --deploy` 检查生产环境配置

## 快速检查清单

部署完成后，请确认：

- [ ] Python虚拟环境已创建并激活
- [ ] 所有依赖已安装 (`pip install -r requirements.txt`)
- [ ] MySQL数据库已创建
- [ ] 数据库配置已更新 (`mysite/local/settings/base.py`)
- [ ] 数据库迁移已执行 (`python manage.py migrate`)
- [ ] 超级用户已创建 (`python manage.py createsuperuser`)
- [ ] 静态文件已收集 (`python manage.py collectstatic`)
- [ ] 开发服务器可以启动 (`python manage.py runserver`)
- [ ] 可以访问管理后台 (http://localhost:8000/admin/)
- [ ] 数据库表已创建（通过 `SHOW TABLES` 验证）

## 总结

完成以上步骤后，你的本地开发环境应该已经成功部署。记住：

1. ✅ 数据库已创建并迁移
2. ✅ 超级用户已创建
3. ✅ 静态文件已收集
4. ✅ 开发服务器正在运行
5. ✅ 可以访问管理后台

祝你部署顺利！

## 附录：常用命令速查

```bash
# 激活虚拟环境
# Windows
env\Scripts\activate
# Linux/macOS
source env/bin/activate

# 安装依赖
pip install -r requirements.txt

# 数据库迁移
python manage.py makemigrations
python manage.py migrate
python manage.py showmigrations

# 创建超级用户
python manage.py createsuperuser

# 收集静态文件
python manage.py collectstatic

# 启动开发服务器
python manage.py runserver

# 检查配置
python manage.py check

# 进入数据库shell
python manage.py dbshell

# 查看迁移计划
python manage.py showmigrations --plan
```
